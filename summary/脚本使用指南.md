# Finedefics 脚本使用指南

本文档说明如何使用 Finedefics 项目中的评估脚本。

---

## 目录结构

```
Finedefics/
├── scripts/
│   ├── config.yaml          # 配置文件
│   └── run_evaluate.sh      # 评估脚本
├── datasets/                 # 数据集目录
├── models/
│   └── Finedefics/          # 模型权重
├── logs/                     # 日志目录
├── results/                  # 结果目录
└── FOCI-Benchmark/          # 评测框架
```

---

## 快速开始

### 1. 修改配置文件

编辑 `scripts/config.yaml`：

```yaml
# 选择要评估的数据集
dataset: dog

# 选择使用的 GPU
gpu: 0

# 设置实验编号（用于区分不同实验）
experiment:
  id: 1
  name: "baseline"
```

### 2. 运行评估

```bash
cd /home/hdl/project/Finedefics/scripts
./run_evaluate.sh
```

或指定配置文件：

```bash
./run_evaluate.sh /path/to/custom_config.yaml
```

### 3. 查看结果

- **日志文件**: `./logs/<dataset>/run_evaluate.log`
- **结果文件**: `./results/exp<id>/mc/<dataset>.json`

---

## 配置文件详解

### config.yaml 完整示例

```yaml
# 环境配置
environment:
  conda_path: /home/hdl/miniconda3  # conda 安装路径
  conda_env: finedefics             # conda 环境名称

# 路径配置 (相对于项目根目录)
paths:
  data_dir: ./datasets              # 数据集目录
  log_dir: ./logs                   # 日志目录
  results_dir: ./results            # 结果保存目录
  finedefics_dir: ./models/Finedefics  # 模型目录

# GPU 配置
gpu: 0  # 使用的 GPU 编号

# 数据集名称
dataset: dog

# 分类评估参数
classification:
  test_ratio: 100.0      # 测试集使用比例 (1-100)
  batch_size: 4          # 批次大小
  max_examples: 9999     # 每类最大样本数
  task: mc               # 任务类型: mc (多选题)
  choice_enumeration: ABCD
  load_quantized: false  # 量化加载: false, 4bit, 8bit

# 实验编号
experiment:
  id: 1
  name: ""
```

---

## 支持的数据集

### 细粒度分类数据集 (FOCI-Benchmark 支持)

| 配置名 | 本地目录 | FOCI名称 | 类别数 |
|--------|----------|----------|--------|
| dog | dogs_120 | dog-120 | 120 |
| bird | CUB_200_2011 | bird-200 | 200 |
| flower | flowers_102 | flower-102 | 102 |
| car | car_196 | car-196 | 196 |
| pet | pet_37 | pet-37 | 37 |
| aircraft | fgvc_aircraft | aircraft-102 | 102 |
| food | food_101 | food101 | 101 |

### 其他数据集

| 配置名 | 本地目录 | 说明 |
|--------|----------|------|
| birdsnap | birdsnap | 鸟类数据集 |
| caltech101 | caltech101 | 通用分类 |
| caltech256 | caltech256 | 通用分类 |
| dtd | dtd | 纹理数据集 |
| eurosat | eurosat | 卫星图像 |
| ucf | ucf101 | 动作识别 |
| sun397 | SUN397 | 场景分类 |
| imagenet_1k | ImageNet_1k | ImageNet |
| imagenet_a | ImageNet_A | ImageNet-A |
| imagenet_r | ImageNet_R | ImageNet-R |
| imagenet_sketch | ImageNet_Sketch | ImageNet-Sketch |
| imagenet_v2 | ImageNet_v2 | ImageNet-v2 |

---

## 日志说明

### 日志文件位置

日志按数据集名称组织：

```
logs/
├── dog/
│   └── run_evaluate.log
├── bird/
│   └── run_evaluate.log
└── ...
```

### 日志格式

```
[2025-12-07 17:30:00] [exp1] Finedefics 评估开始
[2025-12-07 17:30:00] [exp1] 实验编号: 1
[2025-12-07 17:30:00] [exp1] 数据集: dog (目录: dogs_120)
[2025-12-07 17:30:00] [exp1] GPU: 0
...
```

日志中包含实验编号 `[exp1]`，方便区分不同实验。

---

## 结果说明

### 结果文件位置

结果按实验编号组织：

```
results/
├── exp1/
│   └── mc/
│       ├── dog-120--models_Finedefics.json
│       └── bird-200--models_Finedefics.json
├── exp2/
│   └── mc/
│       └── ...
└── ...
```

### 结果文件格式

```json
{
  "metrics": {
    "generation_failures": 0.0,
    "accuracy": 0.73
  },
  "predictions": [...],
  "config": {...}
}
```

- **accuracy**: 分类准确率
- **generation_failures**: 生成失败率

---

## 多实验并行

通过设置不同的实验编号，可以同时运行多个实验：

**实验 1:**
```yaml
experiment:
  id: 1
  name: "baseline"
```

**实验 2:**
```yaml
experiment:
  id: 2
  name: "with_augmentation"
```

不同实验的结果会保存在不同目录：
- 实验 1: `results/exp1/`
- 实验 2: `results/exp2/`

---

## 常见问题

### Q1: 如何调整显存使用？

减小 `batch_size` 或启用量化加载：

```yaml
classification:
  batch_size: 2
  load_quantized: 4bit  # 或 8bit
```

### Q2: 如何只测试部分数据？

设置 `max_examples` 限制每类样本数：

```yaml
classification:
  max_examples: 100  # 每类最多 100 个样本
```

### Q3: 数据集目录在哪里？

数据集应放在 `datasets/` 目录下，每个数据集需要包含 `images_split/split_datasets_images.json` 文件。

详见 `datasets/数据集使用指南.md`。

### Q4: 如何查看支持的数据集？

运行脚本时会自动验证数据集，不支持的数据集会提示错误。

---

## 联系方式

如有问题，请联系项目维护者。
