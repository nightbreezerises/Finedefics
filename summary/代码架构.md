# Finedefics 代码架构

本文档说明 Finedefics 项目的代码结构和各模块功能。

---

## 项目概览

Finedefics 是基于 Idefics2 模型的细粒度图像分类系统，包含模型训练和评估两大功能。

```
Finedefics/
├── scripts/                  # 脚本目录
│   ├── config.yaml          # 统一配置文件
│   └── run_evaluate.sh      # 评估脚本
├── FOCI-Benchmark/          # 评测框架
│   ├── run_ic_bench.py      # 评测入口
│   └── benchmark/           # 评测核心代码
├── datasets/                 # 数据集目录
├── models/                   # 模型权重
├── logs/                     # 日志目录
├── results/                  # 结果目录
├── summary/                  # 文档目录
├── idefics2_fine_tuning.py  # 模型微调脚本
├── qlora_to_merge.py        # QLoRA 权重合并
└── train.sh                  # 训练脚本
```

---

## 核心模块

### 1. 配置系统 (`scripts/config.yaml`)

统一管理所有配置参数：

```yaml
# 配置结构
environment:     # 环境配置 (conda路径、环境名)
paths:           # 路径配置 (数据集、日志、结果、模型)
gpu:             # GPU 配置
dataset:         # 数据集名称
classification:  # 分类评估参数
prompts:         # 提示词配置
dataset_dirs:    # 数据集目录映射
foci_dataset_names:  # FOCI-Benchmark 数据集名映射
experiment:      # 实验配置
```

### 2. 评估脚本 (`scripts/run_evaluate.sh`)

主要功能：
- 解析 YAML 配置文件
- 自动激活 Conda 环境
- 数据集验证和路径映射
- 调用 FOCI-Benchmark 进行评估
- 实时日志记录
- 多实验支持

**执行流程:**

```
┌─────────────────┐
│  读取配置文件    │
└────────┬────────┘
         ▼
┌─────────────────┐
│  解析参数        │
│  设置默认值      │
└────────┬────────┘
         ▼
┌─────────────────┐
│  验证配置        │
│  - 数据集支持    │
│  - 模型目录      │
│  - 数据集目录    │
│  - split文件    │
└────────┬────────┘
         ▼
┌─────────────────┐
│  创建日志/结果目录│
└────────┬────────┘
         ▼
┌─────────────────┐
│  激活 Conda 环境 │
│  设置 GPU       │
└────────┬────────┘
         ▼
┌─────────────────┐
│  判断评估方式    │
│  FOCI / 自定义  │
└────────┬────────┘
         ▼
┌─────────────────┐
│  执行评估        │
│  实时写入日志    │
└────────┬────────┘
         ▼
┌─────────────────┐
│  输出结果        │
└─────────────────┘
```

### 3. FOCI-Benchmark (`FOCI-Benchmark/`)

评测框架目录结构：

```
FOCI-Benchmark/
├── run_ic_bench.py          # 评测入口
├── benchmark/
│   ├── evaluate.py          # 评估逻辑
│   ├── data/
│   │   ├── dataset.py       # 数据集类
│   │   ├── loaders.py       # 数据加载器
│   │   └── options_generation.py  # 选项生成
│   └── model/
│       └── model.py         # 模型封装
└── scripts/
    └── Finedefics.sh        # 示例脚本
```

**核心类:**

- `ICDataset`: 图像分类数据集
- `Idefics2Model`: Idefics2 模型封装
- `HFModel`: HuggingFace 模型基类

### 4. 数据集系统 (`datasets/`)

数据集目录结构：

```
datasets/
├── dogs_120/
│   ├── Images/              # 图片目录
│   └── images_split/
│       ├── split_datasets_images.json  # 训练/测试划分
│       ├── images_train.json
│       ├── images_test.json
│       └── images_discovery_all.json
├── CUB_200_2011/
│   └── ...
└── 数据集使用指南.md
```

**split_datasets_images.json 格式:**

```json
{
  "train": [
    ["类别名称", 类别索引, "图片相对路径"],
    ...
  ],
  "test": [
    ["类别名称", 类别索引, "图片相对路径"],
    ...
  ]
}
```

---

## 数据流

### 评估数据流

```
config.yaml
    │
    ▼
run_evaluate.sh ──────────────────────────────────┐
    │                                              │
    ▼                                              ▼
datasets/<dataset>/                         FOCI-Benchmark/
    │                                              │
    ├── images_split/                              │
    │   └── split_datasets_images.json             │
    │                                              │
    └── Images/                                    │
        └── *.jpg                                  │
                                                   │
                    ┌──────────────────────────────┘
                    │
                    ▼
            run_ic_bench.py
                    │
                    ▼
            benchmark/evaluate.py
                    │
                    ├── 加载数据集 (ICDataset)
                    ├── 加载模型 (Idefics2Model)
                    └── 执行推理
                            │
                            ▼
                    results/exp<id>/mc/*.json
```

---

## 关键函数

### run_evaluate.sh

| 函数 | 功能 |
|------|------|
| `parse_yaml()` | 解析 YAML 配置文件 |
| `parse_yaml_quoted()` | 解析带引号的值 |
| `log()` | 带时间戳和实验编号的日志 |
| `log_header()` | 输出分隔线标题 |

### FOCI-Benchmark

| 文件 | 函数/类 | 功能 |
|------|---------|------|
| `run_ic_bench.py` | `main()` | 评测入口 |
| `evaluate.py` | `main()` | 评估主逻辑 |
| `evaluate.py` | `parse_generated_prediction()` | 解析模型输出 |
| `dataset.py` | `ICDataset` | 图像分类数据集 |
| `model.py` | `Idefics2Model` | 模型封装 |
| `model.py` | `load_model()` | 加载模型 |
| `loaders.py` | `DATASET_TO_LOADER` | 数据集加载器映射 |

---

## 配置映射

### 数据集名称映射

| 配置名 | 本地目录 | FOCI名称 |
|--------|----------|----------|
| dog | dogs_120 | dog-120 |
| bird | CUB_200_2011 | bird-200 |
| flower | flowers_102 | flower-102 |
| car | car_196 | car-196 |
| pet | pet_37 | pet-37 |
| aircraft | fgvc_aircraft | aircraft-102 |
| food | food_101 | food101 |

### 路径映射

| 配置路径 | 实际用途 |
|----------|----------|
| `paths.data_dir` | 数据集根目录 |
| `paths.log_dir` | 日志保存目录 |
| `paths.results_dir` | 结果保存目录 |
| `paths.finedefics_dir` | 模型权重目录 |

---

## 扩展指南

### 添加新数据集

1. 在 `config.yaml` 的 `dataset_dirs` 添加映射
2. 在 `run_evaluate.sh` 的 `DATASET_DIR_MAP` 添加映射
3. 在 `PROMPT_MAP` 添加对应提示词
4. 如需 FOCI-Benchmark 支持，还需修改 `loaders.py`

### 添加新评估指标

修改 `FOCI-Benchmark/benchmark/evaluate.py` 中的 `main()` 函数。

### 添加新模型

在 `FOCI-Benchmark/benchmark/model/model.py` 中添加新的模型类。

---

## 日志系统

### 日志格式

```
[时间戳] [exp实验编号] 消息内容
```

### 日志目录结构

```
logs/
├── dog/
│   └── run_evaluate.log
├── bird/
│   └── run_evaluate.log
└── ...
```

### 日志内容

- 配置参数
- 执行命令
- 评估输出
- 最终结果（准确率）

---

## 结果系统

### 结果目录结构

```
results/
├── exp1/
│   └── mc/
│       ├── dog-120--models_Finedefics.json
│       └── ...
├── exp2/
│   └── mc/
│       └── ...
└── ...
```

### 结果文件格式

```json
{
  "metrics": {
    "generation_failures": 0.0,
    "accuracy": 0.73
  },
  "predictions": [
    {
      "image": "path/to/image.jpg",
      "predicted": "Afghan_hound",
      "predicted_raw": "A",
      "correct": "Afghan_hound",
      "options": ["Afghan_hound", "Beagle", "Collie", "Dalmatian"]
    }
  ],
  "config": {
    "dataset": "dog-120",
    "model": "./models/Finedefics",
    ...
  }
}
```

---

## 依赖关系

```
run_evaluate.sh
    │
    ├── config.yaml (配置)
    │
    ├── FOCI-Benchmark/run_ic_bench.py
    │       │
    │       └── benchmark/evaluate.py
    │               │
    │               ├── benchmark/data/dataset.py
    │               │       │
    │               │       └── benchmark/data/loaders.py
    │               │
    │               └── benchmark/model/model.py
    │
    └── datasets/<dataset>/images_split/split_datasets_images.json
```

---

## 联系方式

如有问题，请联系项目维护者。
